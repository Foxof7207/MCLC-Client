<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCLC - My Dashboard</title>
    <link rel="icon" type="image/png" href="resources/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1bd96a',
                        'primary-dark': '#14a34f',
                        surface: '#121212',
                        background: '#080808',
                        'accent-dark': '#0f0f0f',
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    boxShadow: {
                        'primary-glow': '0 0 30px rgba(27, 217, 106, 0.25)',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-background text-gray-200 selection:bg-primary/30 antialiased overflow-x-hidden">

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-[100] transition-all duration-300 bg-background/80 backdrop-blur-md border-b border-white/5"
        id="navbar">
        <div class="max-w-7xl mx-auto px-6 lg:px-12 py-6 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-3">
                <img src="resources/icon.png" alt="MCLC Logo" class="w-10 h-10 object-contain">
                <span class="text-2xl font-extrabold tracking-tighter text-white">MCLC</span>
            </a>

            <div class="hidden md:flex items-center gap-10 text-sm font-semibold tracking-wide uppercase text-gray-400">
                <a href="index.html" class="hover:text-primary transition-colors">Home</a>
                <a href="extensions.html" class="hover:text-primary transition-colors">Extensions</a>
                <a href="https://github.com/Fernsehheft/MCLC-Client" class="hover:text-primary transition-colors"
                    target="_blank">GitHub</a>
            </div>

            <!-- Auth Container (Populated by main.js) -->
        </div>
    </nav>

    <div class="pt-40 pb-20 px-6 max-w-7xl mx-auto">

        <!-- Dashboard Header -->
        <div
            class="flex flex-col md:flex-row items-center md:items-start gap-10 mb-20 bg-surface/30 p-10 rounded-[2.5rem] border border-white/5">
            <div class="relative group">
                <div class="w-32 h-32 rounded-full border-4 border-surface overflow-hidden shadow-2xl">
                    <img id="profile-avatar" src="https://via.placeholder.com/150" alt="Avatar"
                        class="w-full h-full object-cover">
                </div>
            </div>

            <div class="text-center md:text-left flex-1">
                <div class="flex flex-col md:flex-row md:items-center gap-4 mb-4">
                    <h1 id="profile-username" class="text-5xl font-black text-white tracking-tight">Loading...</h1>
                    <span id="role-badge"
                        class="hidden px-3 py-1 bg-primary/10 text-primary text-[10px] uppercase font-black tracking-widest rounded-full border border-primary/20 w-max self-center md:self-auto">Member</span>
                </div>
                <p id="profile-bio" class="text-gray-400 text-lg max-w-2xl leading-relaxed mb-8">...</p>
                <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                    <button onclick="toggleEditProfile()"
                        class="bg-white/5 hover:bg-white/10 text-white px-6 py-3 rounded-2xl font-bold transition-all text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Edit Profile
                    </button>
                    <a href="admin_extensions.html" id="admin-link"
                        class="hidden bg-red-500/10 hover:bg-red-500 text-red-400 hover:text-black px-6 py-3 rounded-2xl font-bold transition-all text-sm">
                        Admin Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Edit Profile Form (Hidden) -->
        <div id="edit-profile-section" class="hidden mb-20 animate-in fade-in slide-in-from-top-4 duration-500">
            <div class="bg-surface border border-white/10 p-10 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 blur-3xl rounded-full -mr-16 -mt-16"></div>
                <h2 class="text-3xl font-black text-white mb-8">Update Presence</h2>
                <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-500 uppercase tracking-widest">Display
                            Name</label>
                        <input type="text" id="input-username"
                            class="w-full bg-background border border-white/5 rounded-2xl px-6 py-4 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-500 uppercase tracking-widest">Avatar
                            URL</label>
                        <input type="text" id="input-avatar"
                            class="w-full bg-background border border-white/5 rounded-2xl px-6 py-4 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all">
                    </div>
                    <div class="md:col-span-2 space-y-2">
                        <label class="block text-sm font-bold text-gray-500 uppercase tracking-widest">Biography</label>
                        <textarea id="input-bio" rows="4"
                            class="w-full bg-background border border-white/5 rounded-2xl px-6 py-4 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"></textarea>
                    </div>
                    <div class="md:col-span-2 flex gap-4 pt-4">
                        <button type="submit"
                            class="bg-primary hover:bg-primary-dark text-black px-10 py-4 rounded-2xl font-black transition-all shadow-primary-glow">Save
                            Changes</button>
                        <button type="button" onclick="toggleEditProfile()"
                            class="text-gray-500 hover:text-white px-6 py-4 font-bold transition-all">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dashboard Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">

            <!-- Upload Column -->
            <div class="lg:col-span-1">
                <div class="bg-surface/50 border border-white/5 p-8 rounded-[2rem] sticky top-32">
                    <h2 class="text-2xl font-bold text-white mb-2">Contribute</h2>
                    <p class="text-gray-500 text-sm mb-8">Share your extensions with the community.</p>

                    <form id="uploadForm" class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">Name</label>
                            <input type="text" name="name" required
                                class="w-full bg-background border border-white/5 rounded-xl px-5 py-3 text-white focus:border-primary outline-none transition-all">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">Description</label>
                            <textarea name="description" required rows="3"
                                class="w-full bg-background border border-white/5 rounded-xl px-5 py-3 text-white focus:border-primary outline-none transition-all"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">Extension
                                File</label>
                            <input type="file" name="extensionFile" required
                                class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-black file:bg-primary/20 file:text-primary hover:file:bg-primary transition-all">
                        </div>
                        <button type="submit"
                            class="w-full bg-primary/10 hover:bg-primary text-primary hover:text-black font-black py-4 rounded-2xl border border-primary/20 transition-all">Submit
                            Extension</button>
                    </form>
                </div>
            </div>

            <!-- List Column -->
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold text-white mb-8 flex items-center gap-4">
                    Your Creations
                    <span id="ext-count" class="text-xs bg-white/5 px-2 py-1 rounded text-gray-500">0</span>
                </h2>
                <div id="my-extensions-list" class="space-y-4">
                    <!-- Loading skeleton -->
                    <div class="bg-surface border border-white/5 p-6 rounded-2xl animate-pulse h-24"></div>
                    <div class="bg-surface border border-white/5 p-6 rounded-2xl animate-pulse h-24"></div>
                </div>
            </div>
        </div>

    </div>

    <script src="main.js"></script>
    <script>
        let currentUser = null;

        async function loadProfile() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();

                if (!data.loggedIn) {
                    window.location.href = '/auth/google';
                    return;
                }

                currentUser = data.user;

                // Update UI
                document.getElementById('profile-username').textContent = currentUser.username;
                document.getElementById('profile-bio').textContent = currentUser.bio || 'This user is a bit shy and hasn\'t written a bio yet.';
                document.getElementById('profile-avatar').src = currentUser.avatar || 'https://via.placeholder.com/150';

                const roleBadge = document.getElementById('role-badge');
                roleBadge.textContent = currentUser.role;
                roleBadge.classList.remove('hidden');
                if (currentUser.role === 'admin') roleBadge.classList.add('bg-red-500/10', 'text-red-400', 'border-red-500/20');

                // Form values
                document.getElementById('input-username').value = currentUser.username;
                document.getElementById('input-bio').value = currentUser.bio || '';
                document.getElementById('input-avatar').value = currentUser.avatar || '';

                if (currentUser.role === 'admin') {
                    document.getElementById('admin-link').classList.remove('hidden');
                }

                loadMyExtensions();

            } catch (err) {
                console.error('Failed to load profile:', err);
            }
        }

        async function loadMyExtensions() {
            try {
                const res = await fetch('/api/user/extensions');
                const extensions = await res.json();
                const list = document.getElementById('my-extensions-list');
                document.getElementById('ext-count').textContent = extensions.length;

                if (extensions.length === 0) {
                    list.innerHTML = `
                        <div class="bg-surface/30 border border-dashed border-white/5 p-12 rounded-3xl text-center">
                            <p class="text-gray-600 font-bold">You haven't contributed any extensions yet.</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = extensions.map(ext => `
                    <div class="bg-surface border border-white/5 p-6 rounded-2xl flex items-center justify-between group hover:border-white/10 transition-colors">
                        <div>
                            <h3 class="font-bold text-white text-lg group-hover:text-primary transition-colors">${ext.name}</h3>
                            <p class="text-gray-500 text-sm line-clamp-1 mb-2">${ext.description}</p>
                            <span class="text-[10px] font-black uppercase tracking-tighter px-2 py-1 rounded-lg ${getStatusStyle(ext.status)}">
                                ${ext.status}
                            </span>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-600 font-black uppercase tracking-tighter mb-1">Submitted</div>
                            <div class="text-sm font-bold text-gray-400">${new Date(ext.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Error loading my extensions', err);
            }
        }

        function getStatusStyle(status) {
            if (status === 'approved') return 'bg-primary/20 text-primary';
            if (status === 'rejected') return 'bg-red-500/20 text-red-400';
            return 'bg-yellow-500/20 text-yellow-400';
        }

        function toggleEditProfile() {
            const section = document.getElementById('edit-profile-section');
            section.classList.toggle('hidden');
        }

        // Profile Update
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            const data = {
                username: document.getElementById('input-username').value,
                bio: document.getElementById('input-bio').value,
                avatar: document.getElementById('input-avatar').value
            };

            try {
                await fetch('/api/user/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                toggleEditProfile();
                loadProfile();
            } catch (err) {
                alert('Failed to update profile.');
            } finally {
                submitBtn.textContent = 'Save Changes';
                submitBtn.disabled = false;
            }
        });

        // Extension Upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Uploading...';
            submitBtn.disabled = true;

            const formData = new FormData(e.target);

            try {
                const res = await fetch('/api/extensions/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.success) {
                    alert('Success! Extension submitted for review.');
                    e.target.reset();
                    loadMyExtensions();
                } else {
                    alert('Upload failed: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Upload failed.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        loadProfile();
    </script>
</body>

</html>